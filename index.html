<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Peak District Hikes Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.2.0/mapbox-gl.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <style>
    html, body { margin:0; height:100% }
    #map { position:absolute; inset:0 }

    .marker{ cursor:pointer !important; }
    .mapboxgl-popup{ filter:drop-shadow(0 14px 28px rgba(0,0,0,0.45)); }

    /* Popup container */
    .mapboxgl-popup-content{
      background:#fff !important;
      color:#1E1E1E;
      border-radius:12px !important;
      border:none !important;
      box-shadow:0 10px 24px rgba(0,0,0,0.35) !important;
      font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif !important;
      padding:0 !important;
      max-width:none;             /* no forced width */
      width:auto;                 /* shrink to fit content */
      overflow:hidden;
      display:inline-block;       /* shrink-wrap */
    }
    .mapboxgl-popup-tip{ display:none !important; }

    .mapboxgl-popup-close-button{
      color:#333 !important;
      font-size:20px !important;
      top:6px !important;
      right:6px !important;
      padding:0 !important;
      line-height:1;
      z-index:2;
      background:transparent !important;
      border:none !important;
      box-shadow:none !important;
      outline:none !important;
    }

    /* Card layout */
    .popup-card{
      display:flex;
      align-items:stretch;
    }
    .popup-img{
      width:132px;
      flex:0 0 132px;
      background:#eee center/cover no-repeat;
      border-radius:12px 0 0 12px;
      user-select:none;
      -webkit-user-drag:none;
      border:none !important;
      outline:none !important;
      box-shadow:none !important;  /* no black edge */
    }
    .popup-body{
      width:172px;                /* fixed body width to kill right whitespace */
      min-width:0;
      padding:8px 28px 10px 10px; /* extra right pad so title does not sit under the X */
      text-align:center;          /* centre all text */
    }

    .popup-heading{
      font-weight:700;
      font-size:14px;
      line-height:1.25;
      margin:0 0 6px 0;
      color:#1E1E1E;
      white-space:normal;
      word-break:keep-all;
    }

    .specs{
      font-size:13px;
      display:flex;
      flex-direction:column;
      gap:4px;
      align-items:center;
    }
    .spec-row{
      display:flex;
      align-items:center;
      gap:6px;
      justify-content:center;
      width:100%;
    }
    .icon{
      width:16px; height:16px; flex:0 0 16px; color:#1E1E1E;
    }
    .spec-value{ font-weight:800; color:#EC2629; }

    .popup-actions{
      display:flex;
      gap:6px;
      justify-content:center;
      align-items:center;
      margin-top:8px;
    }
    .popup-link{
      color:#3899EC;
      font-weight:600;
      text-decoration:none;
      -webkit-tap-highlight-color:transparent;
    }
    .mapboxgl-popup-content a,
    .mapboxgl-popup-content a:focus,
    .mapboxgl-popup-content a:active{
      outline:none !important;
      box-shadow:none !important;
      border:none !important;     /* no black line on link */
      background:transparent !important;
    }

    @media (max-width:440px){
      .popup-img{ width:120px; flex-basis:120px; }
      .popup-body{ width:160px; }
    }
  </style>
</head>
<body>
<div id="map"></div>

<script src="https://api.mapbox.com/mapbox-gl-js/v3.2.0/mapbox-gl.js"></script>
<script src="https://unpkg.com/@tmcw/togeojson@5.8.0/dist/togeojson.umd.js"></script>
<script>
mapboxgl.accessToken="pk.eyJ1IjoicmVtbWlhZ2JlYmkiLCJhIjoiY21odHRrYTQzMTk0bjJqcjE1b2xhZ2FraSJ9.nTCz33gX0gQt3T4A6VD0oQ";

const RED  = "#EC2629";
const BLUE = "#3899EC";

/* Raw GitHub images */
const IMG = {
  derwent: "https://raw.githubusercontent.com/remmiagbebi-beep/peak-district-map/main/images/derwent-dam-tower.jpg",
  crashed: "https://raw.githubusercontent.com/remmiagbebi-beep/peak-district-map/main/images/b29-overexposed-crash-site.jpg",
  kinder:  "https://raw.githubusercontent.com/remmiagbebi-beep/peak-district-map/main/images/kinder-scout-carved-rock.png"
};

const hikes = [
  {
    id:"derwent-edge",
    name:"Derwent Edge",
    coords:[-1.7427849606990842,53.400582126300236],
    hikeUrl:"https://thelostpeak.co.uk/hikes/derwent-edge",
    directionsUrl:"https://www.google.com/maps/dir/?api=1&destination=53.400582126300236,-1.7427849606990842",
    gpx:"https://raw.githubusercontent.com/remmiagbebi-beep/peak-district-map/refs/heads/main/gpx/Derwent%20Edge.gpx",
    photo:IMG.derwent,
    specs:{ duration:"3 to 4 hours", length:"7.4 miles", ascent:"367m" }
  },
  {
    id:"crashed-plane",
    name:"Crashed Plane Hike",   // removed "The"
    coords:[-1.8689,53.4329],
    hikeUrl:"https://thelostpeak.co.uk/hikes/crashed-plane",
    directionsUrl:"https://www.google.com/maps/dir/?api=1&destination=53.4329,-1.8689",
    gpx:"https://raw.githubusercontent.com/remmiagbebi-beep/peak-district-map/refs/heads/main/gpx/The%20Crashed%20Plane%20Hike.gpx",
    photo:IMG.crashed,
    specs:{ duration:"2 to 3 hours", length:"3.6 miles", ascent:"145m" }
  },
  {
    id:"kinder-scout",
    name:"Kinder Scout",
    coords:[-1.8151209383535991,53.364872107766416],
    hikeUrl:"https://thelostpeak.co.uk/hikes/kinder-scout",
    directionsUrl:"https://www.google.com/maps/dir/?api=1&destination=53.364872107766416,-1.8151209383535991",
    gpx:"https://raw.githubusercontent.com/remmiagbebi-beep/peak-district-map/refs/heads/main/gpx/Kinder%20Scout%20Hike.gpx",
    photo:IMG.kinder,
    specs:{ duration:"4 to 6 hours", length:"8.3 miles", ascent:"562m" }
  }
];

const map = new mapboxgl.Map({
  container:"map",
  style:"mapbox://styles/mapbox/satellite-streets-v12",
  center:[-1.78,53.41],
  zoom:8.6            /* zoomed out further by default */
});
map.addControl(new mapboxgl.NavigationControl(),"bottom-right");

const markerElsById = {};
const routeLayerId = {};
let hoveredId = null;
let rafToken = null;

/* hover sync */
function setMarkerColor(id,color){
  const el = markerElsById[id];
  if(!el) return;
  const path = el.querySelector("svg path");
  if(path) path.setAttribute("fill",color);
}
function setRouteColor(id,color){
  const lyr = routeLayerId[id];
  if(lyr && map.getLayer(lyr)){
    map.setPaintProperty(lyr,"line-color",color);
  }
}
function applyHoverState(){
  rafToken=null;
  Object.keys(routeLayerId).forEach(id=>setRouteColor(id,RED));
  Object.keys(markerElsById).forEach(id=>setMarkerColor(id,RED));
  if(hoveredId){
    setRouteColor(hoveredId,BLUE);
    setMarkerColor(hoveredId,BLUE);
    map.getCanvas().style.cursor="pointer";
  } else {
    map.getCanvas().style.cursor="";
  }
}
function setHovered(id){
  hoveredId=id;
  if(!rafToken) rafToken=requestAnimationFrame(applyHoverState);
}

/* icons */
const icons={
  clock:`<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/><path d="M12 7v6l4 2"/></svg>`,
  length:`<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 8h18M3 16h18"/><path d="M6 8v8M10 8v8M14 8v8M18 8v8"/></svg>`,
  ascent:`<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 20h18"/><path d="M6 18l5-6 4 4 5-7"/><path d="M20 7h-5v5"/></svg>`
};

function specsHTML(s,urls){
  return `
    <div class="specs">
      <div class="spec-row">${icons.clock}<span class="spec-value">${s.duration}</span></div>
      <div class="spec-row">${icons.length}<span class="spec-value">${s.length}</span></div>
      <div class="spec-row">${icons.ascent}<span class="spec-value">${s.ascent}</span></div>
      <div class="popup-actions">
        <a class="popup-link" href="${urls.hikeUrl}" target="_blank" rel="noopener">Hike Page</a>
        <span style="font-weight:800;">&amp;</span>
        <a class="popup-link" href="${urls.directionsUrl}" target="_blank" rel="noopener">Directions</a>
      </div>
    </div>`;
}

function popupHtmlFor(h){
  return `
    <div class="popup-card">
      <div class="popup-img" style="background-image:url('${h.photo}')"></div>
      <div class="popup-body">
        <div class="popup-heading">${h.name}</div>
        ${specsHTML(h.specs,{hikeUrl:h.hikeUrl,directionsUrl:h.directionsUrl})}
      </div>
    </div>`;
}

/* GPX */
async function loadGpx(gpxUrl){
  const res=await fetch(gpxUrl);
  const xml=new DOMParser().parseFromString(await res.text(),"text/xml");
  const gj=toGeoJSON.gpx(xml);
  return gj.features.find(f=>f.geometry && f.geometry.type==="LineString");
}
function addRoute(id,line){
  const src=`route-src-${id}`;
  const lyr=`route-lyr-${id}`;
  if(!map.getSource(src))
    map.addSource(src,{type:"geojson",data:line});
  if(!map.getLayer(lyr)){
    map.addLayer({
      id:lyr,
      type:"line",
      source:src,
      paint:{
        "line-color":RED,
        "line-width":4,
        "line-opacity":0.95
      }
    });
  }
  routeLayerId[id]=lyr;
}

/* init */
map.on("load", async () => {
  const bounds=new mapboxgl.LngLatBounds();

  hikes.forEach(h=>{
    const marker=new mapboxgl.Marker({color:RED})
      .setLngLat(h.coords)
      .setPopup(new mapboxgl.Popup({offset:22}).setHTML(popupHtmlFor(h)))
      .addTo(map);

    const el=marker.getElement();
    el.classList.add("marker");
    markerElsById[h.id]=el;

    bounds.extend(h.coords);

    el.addEventListener("mouseenter",()=>setHovered(h.id));
    el.addEventListener("mouseleave",()=>setHovered(null));
    el.addEventListener("click",()=>{
      if(window.innerWidth<700) map.easeTo({center:h.coords,duration:400});
    });
  });

  for(const h of hikes){
    try{
      const line=await loadGpx(h.gpx);
      addRoute(h.id,line);
      line.geometry.coordinates.forEach(c=>bounds.extend(c));
      map.on("mouseenter",routeLayerId[h.id],()=>setHovered(h.id));
      map.on("mouseleave",routeLayerId[h.id],()=>setHovered(null));
    }catch(e){}
  }

  /* Fit all but cap how far in it can zoom. Lower maxZoom = more zoomed out. */
  map.fitBounds(bounds,{padding:100, maxZoom:8.6});
});
</script>
</body>
</html>
